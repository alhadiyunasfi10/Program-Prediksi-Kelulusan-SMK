<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Analisis Model</title>

    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ url_for('static', filename='images/favicon-32x32.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ url_for('static', filename='images/favicon-16x16.png') }}"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <!-- LOGOUT MODAL -->
    <div
      id="logoutModal"
      class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-50"
    >
      <div
        id="logoutBox"
        class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 transform scale-90 opacity-0 transition-all duration-300"
      >
        <h3 class="text-lg font-bold text-gray-700 mb-2 text-center">
          Konfirmasi Logout
        </h3>
        <p class="text-sm text-gray-500 text-center mb-6">
          Apakah Anda yakin ingin keluar dari sistem?
        </p>
        <div class="flex justify-center gap-4">
          <button
            onclick="closeLogoutModal()"
            class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition"
          >
            Batal
          </button>
          <a
            href="/logout"
            class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition"
          >
            Logout
          </a>
        </div>
      </div>
    </div>
    <!-- HEADER -->
    <header class="bg-white/80 backdrop-blur shadow sticky top-0 z-50">
      <div
        class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center"
      >
        <div>
          <h1 class="text-lg font-bold text-blue-600">
            Sistem Prediksi Kelulusan SMK
          </h1>
          <p class="text-xs text-gray-500">Random Forest â€¢ Dashboard Utama</p>
        </div>

        <nav class="flex items-center space-x-6">
          <span class="text-sm text-gray-600">
            ðŸ‘¤ {{ user }}
            <span class="text-xs text-blue-600 font-semibold"
              >({{ role|capitalize }})</span
            >
          </span>

          <a
            href="/dashboard"
            class="relative text-sm text-gray-600 hover:text-blue-600 transition"
          >
            Dashboard
          </a>

          <a
            href="/analisis"
            class="relative text-sm text-blue-700 font-semibold after:content-[''] after:absolute after:left-0 after:-bottom-1 after:h-[2px] after:w-full after:bg-blue-600"
          >
            Analisis
          </a>
          <a
            href="/prediksi"
            class="relative text-sm text-gray-600 hover:text-blue-600 transition"
          >
            Prediksi
          </a>
          <a
            href="/hasil-prediksi"
            class="text-sm text-gray-600 hover:text-blue-600 transition"
          >
            Hasil
          </a>

          <a
            href="/about"
            class="relative text-sm text-gray-600 hover:text-blue-600 transition"
          >
            About
          </a>

          <button
            onclick="openLogoutModal()"
            class="text-sm text-red-500 hover:text-red-700 transition font-medium"
          >
            Logout
          </button>
        </nav>
      </div>
    </header>
    <!-- DATASET AWAL -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="text-xl font-semibold text-center mb-4 text-gray-700">
          Data Mentah (Dataset yang Baru Diupload)
        </h3>

        <p class="text-sm text-gray-500 text-center mb-6">
          Berikut adalah contoh data sebelum dilakukan proses preprocessing.
        </p>

        {% if contoh_data_awal %}
        <div class="overflow-x-auto">
          <table class="w-full border text-sm">
            <thead class="bg-gray-100">
              <tr>
                {% for key in contoh_data_awal[0].keys() %}
                <th class="border px-3 py-2">{{ key }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in contoh_data_awal %}
              <tr class="hover:bg-blue-50 text-center">
                {% for value in row.values() %}
                <td class="border px-3 py-2">{{ value }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">Data belum tersedia.</p>
        {% endif %}
      </div>
    </div>

    <!-- PREPROCESSING SUMMARY -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="text-xl font-semibold text-center mb-4 text-gray-700">
          Hasil Preprocessing Data (Cleaning dan Encoding)
        </h3>

        <p class="text-sm text-gray-500 text-center mb-6">
          Tahap preprocessing dilakukan untuk memastikan kualitas data sebelum
          digunakan dalam pelatihan dan pengujian model Random Forest.
        </p>

        <!-- RINGKASAN JUMLAH DATA -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-blue-50 rounded-lg p-5 text-center">
            <p class="text-sm text-gray-600">Jumlah Data Awal</p>
            <p class="text-2xl font-bold text-blue-700">
              {{ jumlah_awal }} Data
            </p>
          </div>

          <div class="bg-green-50 rounded-lg p-5 text-center">
            <p class="text-sm text-gray-600">
              Jumlah Data Setelah Preprocessing
            </p>
            <p class="text-2xl font-bold text-green-700">
              {{ jumlah_bersih }} Data
            </p>
          </div>
        </div>

        <!-- CONTOH DATA -->
        <h4 class="font-semibold text-gray-700 mb-3">
          Contoh Data Setelah Preprocessing
        </h4>

        {% if contoh_data %}
        <div class="overflow-x-auto">
          <table class="w-full border text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-3 py-2">Rata-rata</th>
                <th class="border px-3 py-2">UKK</th>
                <th class="border px-3 py-2">Prakerin</th>
                <th class="border px-3 py-2">Kehadiran (%)</th>
                <th class="border px-3 py-2">Sikap</th>
                <th class="border px-3 py-2">Administrasi</th>
                <th class="border px-3 py-2">Kelulusan</th>
              </tr>
            </thead>
            <tbody>
              {% for row in contoh_data %}
              <tr class="hover:bg-blue-50 text-center">
                <td class="border px-3 py-2">{{ row["RATA-RATA"] }}</td>
                <td class="border px-3 py-2">{{ row["NILAI UKK"] }}</td>
                <td class="border px-3 py-2">{{ row["PRAKERIN"] }}</td>
                <td class="border px-3 py-2">
                  {{ row["Persentase_Kehadiran"] }}
                </td>
                <td class="border px-3 py-2">{{ row["Sikap"] }}</td>
                <td class="border px-3 py-2">
                  {{ row["Status_Pembayaran_Administrasi"] }}
                </td>

                <td class="border px-3 py-2">{{ row["Status_Kelulusan"] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">Data preprocessing tidak tersedia.</p>
        {% endif %}

        <!-- CATATAN AKADEMIK -->
        <p class="text-xs text-gray-500 mt-4 italic">
          * Data telah melalui proses penghapusan duplikasi, penanganan nilai
          kosong, validasi tipe data numerik, validasi rentang kehadiran, serta
          encoding data kategorik.
        </p>
      </div>
    </div>

    <!-- SELEKSI FITUR DAN TARGET -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="text-xl font-semibold text-center mb-4 text-gray-700">
          Seleksi Fitur dan Pemisahan Target
        </h3>

        <p class="text-sm text-gray-500 text-center mb-6">
          Pada tahap ini dilakukan pemisahan antara variabel independen (fitur)
          dan variabel dependen (target).
        </p>

        <!-- RINGKASAN -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-blue-50 rounded-lg p-5 text-center">
            <p class="text-sm text-gray-600">Jumlah Data</p>
            <p class="text-2xl font-bold text-blue-700">
              {{ jumlah_data }} Data
            </p>
          </div>

          <div class="bg-green-50 rounded-lg p-5 text-center">
            <p class="text-sm text-gray-600">Jumlah Fitur</p>
            <p class="text-2xl font-bold text-green-700">
              {{ jumlah_fitur }} Fitur
            </p>
          </div>
        </div>

        <!-- DAFTAR FITUR -->
        <div class="mb-6">
          <h4 class="font-semibold text-gray-700 mb-2">
            Fitur yang Digunakan:
          </h4>
          <ul class="list-disc list-inside text-sm text-gray-600">
            <li>RATA-RATA</li>
            <li>NILAI UKK</li>
            <li>PRAKERIN</li>
            <li>Persentase_Kehadiran</li>
            <li>Sikap</li>
            <li>Status_Pembayaran_Administrasi</li>
          </ul>
        </div>

        <!-- CONTOH DATA FITUR -->
        <h4 class="font-semibold text-gray-700 mb-3">Contoh Data Fitur (X)</h4>

        <div class="overflow-x-auto mb-6">
          <table class="w-full border text-sm">
            <thead class="bg-gray-100">
              <tr>
                {% for key in contoh_X[0].keys() %}
                <th class="border px-3 py-2">{{ key }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in contoh_X %}
              <tr class="hover:bg-blue-50 text-center">
                {% for value in row.values() %}
                <td class="border px-3 py-2">{{ value }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- TARGET -->
        <h4 class="font-semibold text-gray-700 mb-3">Contoh Target (y)</h4>

        <div class="flex gap-2 flex-wrap">
          {% for value in contoh_y %}
          <span
            class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm"
          >
            {{ value }}
          </span>
          {% endfor %}
        </div>

        <p class="text-xs text-gray-500 mt-4 italic">
          Target berupa variabel Status_Kelulusan yang telah diencoding (0 =
          Tidak Lulus, 1 = Lulus).
        </p>
      </div>
    </div>

    <!-- Split Data -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="font-bold text-lg mb-2">Data Splitting</h3>
        <p>Data Training: {{ jumlah_train }} ({{ persen_train }}%)</p>
        <p>Data Testing: {{ jumlah_test }} ({{ persen_test }}%)</p>
      </div>
    </div>

    <!-- Distribusi Kelas -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="font-bold text-lg mb-2">Distribusi Kelas</h3>
        <p><strong>Training:</strong> {{ distribusi_train }}</p>
        <p><strong>Testing:</strong> {{ distribusi_test }}</p>
      </div>
    </div>

    <!-- Konfigurasi Parameter -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="font-bold text-lg mb-2">
          Konfigurasi Parameter Random Forest
        </h3>
        <ul>
          <li>
            Jumlah Pohon (n_estimators): {{ parameter_model.n_estimators }}
          </li>
          <li>
            Kedalaman Maksimum (max_depth): {{ parameter_model.max_depth }}
          </li>
          <li>Min Samples Split: {{ parameter_model.min_samples_split }}</li>
          <li>Min Samples Leaf: {{ parameter_model.min_samples_leaf }}</li>
          <li>Class Weight: {{ parameter_model.class_weight }}</li>
        </ul>
      </div>
    </div>

    <!-- Bootstrap Sampling -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="font-bold text-lg mb-2">Bootstrap Sampling</h3>
        <p>Bootstrap: Aktif</p>
        <p>Out-of-Bag Score: {{ oob_score }}</p>

        <h3 class="font-bold text-lg mt-6 mb-2">
          Pengaruh Jumlah Pohon terhadap Performa Model
        </h3>

        <img
          src="{{ url_for('static', filename='grafik_jumlah_pohon.png') }}"
          class="w-full mb-4"
        />

        <!-- Tambahan Penjelasan -->
        <div class="text-gray-700 text-justify space-y-3">
          <p>
            Grafik di atas menunjukkan hubungan antara jumlah pohon
            (n_estimators) dalam algoritma Random Forest terhadap nilai
            Out-of-Bag (OOB) Score. OOB Score digunakan sebagai estimasi
            performa model tanpa memerlukan data validasi tambahan, karena
            dihitung dari data bootstrap yang tidak terpilih selama proses
            pelatihan.
          </p>

          <p>
            Berdasarkan hasil pengujian, model menghasilkan nilai Out-of-Bag
            Score sebesar <strong>{{ oob_score }}</strong>. Nilai ini
            menunjukkan bahwa model memiliki tingkat akurasi sekitar {{
            (oob_score * 100)|round(2) }}% terhadap data pelatihan yang tidak
            terambil dalam proses bootstrap, sehingga dapat dikatakan model
            memiliki kemampuan generalisasi yang sangat baik.
          </p>

          <p>
            Dari grafik terlihat bahwa peningkatan jumlah pohon memberikan
            stabilitas performa model hingga mencapai titik konvergen. Setelah
            jumlah pohon mencapai sekitar 100 atau lebih, nilai OOB Score
            cenderung stabil dan tidak mengalami peningkatan yang signifikan.
            Hal ini menunjukkan bahwa penambahan pohon dalam jumlah besar tidak
            selalu meningkatkan performa, tetapi hanya menambah kompleksitas dan
            waktu komputasi.
          </p>

          <p>
            Oleh karena itu, jumlah pohon dipilih berdasarkan keseimbangan
            antara akurasi dan efisiensi komputasi, sehingga model tetap optimal
            tanpa mengalami pemborosan sumber daya.
          </p>
        </div>
      </div>
    </div>

    <!-- Random Feature Selection -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="font-bold text-lg mb-2">Random Feature Selection</h3>

        <p>Total Fitur Dataset: <strong>{{ jumlah_fitur }}</strong></p>
        <p>Metode Pemilihan Fitur: <strong>{{ max_features }}</strong></p>
        <p>
          Jumlah Fitur yang Dipilih Setiap Split:
          <strong>{{ fitur_dipilih }}</strong>
        </p>
        <div class="text-gray-700 text-justify space-y-2 mt-4">
          <p>
            Random Feature Selection adalah mekanisme dalam Random Forest di
            mana setiap node hanya menggunakan sebagian fitur yang dipilih
            secara acak untuk menentukan split terbaik.
          </p>

          <p>
            Pada model ini digunakan metode
            <strong>{{ max_features }}</strong>, sehingga setiap split hanya
            mempertimbangkan <strong>{{ fitur_dipilih }}</strong> fitur dari
            total <strong>{{ jumlah_fitur }}</strong> fitur yang tersedia.
          </p>

          <p>
            Pendekatan ini membantu meningkatkan variasi antar pohon dan
            mengurangi risiko overfitting.
          </p>
        </div>
      </div>
    </div>

    <!-- Pohon Keputusan -->
    <div class="max-w-6xl mx-auto px-6">
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="font-bold text-lg mb-4">
          Visualisasi Pohon Keputusan dalam Random Forest
        </h3>
        <h4 class="font-semibold mb-2">Versi Ringkas (3 Level Pertama)</h4>
        <img
          src="{{ url_for('static', filename='contoh_pohon_3level.png') }}"
          class="w-full"
        />
        <p class="text-gray-700 text-justify mt-4">
          Visualisasi ini dibatasi hingga tiga level pertama untuk mempermudah
          interpretasi struktur awal pembentukan keputusan.
        </p>
        <h4 class="font-semibold mb-2">Versi Lengkap (Full Depth)</h4>
        <img
          src="{{ url_for('static', filename='contoh_pohon_full.png') }}"
          class="w-full mb-4"
        />
        <p class="text-gray-700 text-justify mb-6">
          Gambar di atas menunjukkan struktur lengkap salah satu pohon dalam
          Random Forest sesuai dengan parameter pelatihan (max_depth = 10).
        </p>
      </div>
    </div>

    <!-- CONTENT -->
    <main class="max-w-6xl mx-auto px-6 py-2">
      <h2 class="text-2xl font-bold text-gray-700 mb-3 text-center">
        Analisis Performa Model Random Forest
      </h2>

      <p class="text-center text-sm text-gray-500 mb-8">
        Halaman ini menampilkan hasil evaluasi model Random Forest berdasarkan
        data uji menggunakan metrik evaluasi standar machine learning.
      </p>

      <!-- METRIC -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
        <div class="bg-white rounded-xl shadow p-5 text-center">
          <p class="text-gray-500 text-sm">Akurasi</p>
          <p class="text-2xl font-bold text-blue-600">
            {{ "%.2f"|format(accuracy * 100.0) }}%
          </p>
        </div>

        <div class="bg-white rounded-xl shadow p-5 text-center">
          <p class="text-gray-500 text-sm">Precision</p>
          <p class="text-2xl font-bold text-green-600">
            {{ "%.2f"|format(precision * 100.0) }}%
          </p>
        </div>

        <div class="bg-white rounded-xl shadow p-5 text-center">
          <p class="text-gray-500 text-sm">Recall</p>
          <p class="text-2xl font-bold text-yellow-600">
            {{ "%.2f"|format(recall * 100.0) }}%
          </p>
        </div>

        <div class="bg-white rounded-xl shadow p-5 text-center">
          <p class="text-gray-500 text-sm">F1-Score</p>
          <p class="text-2xl font-bold text-purple-600">
            {{ "%.2f"|format(f1 * 100.0) }}%
          </p>
        </div>
      </div>

      <!-- Overvitting Check -->
      <div class="max-w-6xl mx-auto px-6">
        <div class="bg-white rounded-xl shadow p-8 mb-12">
          <h3 class="font-bold text-lg mb-2">Analisis Overfitting</h3>
          <p>Training Accuracy: {{ train_accuracy }}</p>
          <p>Testing Accuracy: {{ test_accuracy }}</p>
          <p>Selisih: {{ selisih_akurasi }}</p>
          <p><strong>Status:</strong> {{ status_model }}</p>
        </div>
      </div>

      <!-- GRAFIK -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-semibold text-center mb-4 text-gray-700">
            Confusion Matrix
          </h3>
          <img
            src="{{ url_for('static', filename='confusion_matrix.png') }}"
            class="mx-auto rounded"
          />
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-semibold text-center mb-4 text-gray-700">
            Persentase Kelulusan Aktual
          </h3>
          <img
            src="{{ url_for('static', filename='persentase_kelulusan.png') }}"
            class="mx-auto rounded"
          />
          <p class="text-xs text-gray-500 text-center mt-2">
            *Berdasarkan data aktual, bukan hasil prediksi model
          </p>
        </div>
      </div>

      <!-- MATRIKS KORELASI -->
      <div class="bg-white rounded-xl shadow p-8 mb-12">
        <h3 class="text-xl font-semibold text-center mb-4 text-gray-700">
          Matriks Korelasi Antar Variabel
        </h3>

        <p class="text-sm text-gray-500 text-center mb-6">
          Matriks korelasi menunjukkan hubungan antar variabel numerik dalam
          dataset setelah preprocessing.
        </p>

        <div class="flex justify-center">
          <img
            src="{{ url_for('static', filename='matriks_korelasi.png') }}"
            class="rounded shadow max-w-full"
          />
        </div>

        <p class="text-xs text-gray-500 text-center mt-4 italic">
          *Nilai mendekati 1 menunjukkan korelasi positif kuat, mendekati -1
          korelasi negatif kuat.
        </p>
      </div>

      <!-- FEATURE IMPORTANCE -->
      <div class="bg-white rounded-xl shadow p-8">
        <h3 class="text-xl font-semibold text-center mb-6 text-gray-700">
          Feature Importance
        </h3>

        {% if feature_data %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- GRAFIK BATANG -->
          <div>
            <canvas id="featureChart"></canvas>
          </div>

          <!-- TABEL -->
          <div class="overflow-x-auto">
            <table class="w-full border text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border px-4 py-2">No</th>
                  <th class="border px-4 py-2 text-left">Fitur</th>
                  <th class="border px-4 py-2 text-center">Kepentingan</th>
                </tr>
              </thead>
              <tbody>
                {% for f in feature_data %}
                <tr class="hover:bg-blue-50">
                  <td class="border px-4 py-2 text-center">{{ loop.index }}</td>
                  <td class="border px-4 py-2">{{ f.fitur }}</td>
                  <td
                    class="border px-4 py-2 text-center font-semibold text-blue-600"
                  >
                    {{ f.nilai }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
        <p class="text-center text-gray-500">
          Data feature importance belum tersedia.
        </p>
        {% endif %}
      </div>
    </main>
    <!-- BUTTON -->
    <div class="flex justify-center gap-4 mb-10 pt-3">
      <a
        href="/prediksi"
        class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg shadow transition"
      >
        ðŸ”® Ke Halaman Prediksi
      </a>
    </div>

    <footer class="bg-white text-center text-sm text-gray-500 py-4 border-t">
      By Alhadi Yunasfi Â© 2026 Sistem Prediksi Kelulusan SMK
    </footer>
    <script>
      function openLogoutModal() {
        const modal = document.getElementById("logoutModal");
        const box = document.getElementById("logoutBox");
        modal.classList.remove("hidden");
        setTimeout(() => {
          box.classList.remove("scale-90", "opacity-0");
          box.classList.add("scale-100", "opacity-100");
        }, 10);
      }

      function closeLogoutModal() {
        const modal = document.getElementById("logoutModal");
        const box = document.getElementById("logoutBox");
        box.classList.add("scale-90", "opacity-0");
        box.classList.remove("scale-100", "opacity-100");
        setTimeout(() => modal.classList.add("hidden"), 300);
      }
    </script>

    <!-- ðŸ”½ TARUH SCRIPT FEATURE IMPORTANCE DI SINI -->
    {% if feature_data %}
    <script>
      // DATA DARI FLASK (AMAN UNTUK JINJA)
      const featureLabels = JSON.parse(
        '{{ feature_data | map(attribute="fitur") | list | tojson }}',
      );
      const featureValues = JSON.parse(
        '{{ feature_data | map(attribute="nilai") | list | tojson }}',
      );

      const ctx = document.getElementById("featureChart");
      if (ctx) {
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: featureLabels,
            datasets: [
              {
                label: "Feature Importance",
                data: featureValues,
                backgroundColor: "rgba(59,130,246,0.7)",
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: { beginAtZero: true },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }
    </script>
    {% endif %}
  </body>
</html>
